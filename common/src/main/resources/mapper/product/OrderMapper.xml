<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.anyi.common.product.mapper.OrderMapper">
    <select id="conditionCountOrderGroupByRecycler" resultType="com.anyi.common.product.domain.dto.OrderShippingCountDTO">
        select recycler_company_id,
        ifnull(count(nullif(id, 0)), 0) as `count`
        from mb_order
        <where>
            and deleted = 0
            and store_company_id = #{req.storeCompanyId}
            and status = #{req.status}
            <choose>
                <when test="req.countType != null and req.countType == 1">
                    and #{req.now} <![CDATA[ <= ]]> shipping_overdue_time
                </when>
                <when test="req.countType != null and req.countType == 2">
                    and #{req.now} <![CDATA[ >]]> shipping_overdue_time
                </when>
                <otherwise>
                </otherwise>
            </choose>
            <if test="req.recyclerCompanyIds != null and req.recyclerCompanyIds.size() > 0">
                and recycler_company_id in
                <foreach collection="req.recyclerCompanyIds" item="recyclerId" open="(" separator="," close=")">
                    #{recyclerId}
                </foreach>
            </if>
            group by recycler_company_id
        </where>
    </select>
    <select id="countOrderVerifyGroupByRecycler" resultType="com.anyi.common.product.domain.dto.OrderShippingCountDTO">
        select recycler_company_id,
        ifnull(count(nullif(id, 0)), 0) as `count`
        from mb_order
        <where>
            and deleted = 0
            and status = 2
            and verified = #{req.verified}
            and store_company_id = #{req.storeCompanyId}
            and recycler_company_id = #{req.recyclerCompanyId}
            group by recycler_company_id
        </where>
    </select>



    <select id="companyTransStatGroupByEmployee" resultType="com.anyi.common.mobileStat.domain.CompanyDataDailyBase">
        SELECT
         count(1) as transNum
        FROM mb_order
        WHERE
          status in (1, 2, 3, 4)
          AND finish_quote_time between #{beginTime} and #{endTime}
          AND store_employee_id in
          <foreach collection="employeeIds" index="index" item="empId" open="(" separator="," close=")">
            #{empId}
         </foreach>
    </select>

    <select id="companyOrderStatGroupByEmployee" resultType="com.anyi.common.mobileStat.domain.CompanyDataDailyBase">
        SELECT
        count(1) as orderNum
        FROM mb_order
        WHERE create_time between #{beginTime} and #{endTime}
        AND store_employee_id in
        <foreach collection="employeeIds" index="index" item="empId" open="(" separator="," close=")">
            #{empId}
        </foreach>
    </select>

    <select id="priceOrderStatGroupByEmployee" resultType="com.anyi.common.mobileStat.domain.CompanyDataDailyBase">
        SELECT
               count(1)                    as priceNum,
               ifnull(sum(final_price), null) as finalPriceAmount
        FROM mb_order
        WHERE status in (1, 2, 3, 4)
          and finish_quote_time between #{beginTime} and #{endTime}
        AND store_employee_id in
        <foreach collection="employeeIds" index="index" item="empId" open="(" separator="," close=")">
            #{empId}
        </foreach>
    </select>

    <select id="cancelStatGroupByEmployee" resultType="com.anyi.common.mobileStat.domain.CompanyDataDailyBase">
        SELECT
               count(1)          as cancelNum
        from mb_order a
                 INNER JOIN mb_order_log b on a.id = b.order_id
        where a.status = -1
          and b.status = 9
          AND b.create_time between #{beginTime} and #{endTime}
        AND a.store_employee_id in
        <foreach collection="employeeIds" index="index" item="empId" open="(" separator="," close=")">
            #{empId}
        </foreach>
    </select>

    <select id="overTimeStatGroupByEmployee" resultType="com.anyi.common.mobileStat.domain.CompanyDataDailyBase">
        SELECT
               count(1)          as overtimeNum
        from mb_order a
                 INNER JOIN mb_order_log b on a.id = b.order_id
        where a.status = -1
          and b.status = 10
          AND b.create_time between #{beginTime} and #{endTime}
        AND a.store_employee_id in
        <foreach collection="employeeIds" index="index" item="empId" open="(" separator="," close=")">
            #{empId}
        </foreach>
    </select>


</mapper>